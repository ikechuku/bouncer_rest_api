version: 2.1

executors:
  execdocker:
    docker:
      - image: circleci/python:3.7-stretch-node
      - image: circleci/postgres:9.6.2
        name: db
        environment:
          POSTGRES_DB: bouncerdb

jobs:
  build:
    executor: execdocker
    working_directory: ~/app
    steps:
      - checkout
      - run:
          name: Install postgresql for the primary container
          command: |
            sudo apt-get update
            pip install --user psycopg2
      - run:
          name: Install all application dependencies
          command: pip install --user -r requirements.txt
      - run:
          name: Run all test cases in tests folder
          command: |
            cd bouncer
            python manage.py test -p test_*.py api.tests
  
  staging-deploy:
    machine:
      enabled: true
    working_directory: ~/app
    steps:
      - checkout
      - run:
          name: Deploy application to staging environment
          command: docker ps

  production-deploy:
    machine:
      enabled: true
    working_directory: ~/app
    steps:
      - checkout
      - run:
          name: Deploy application to production environment
          command: echo $(pwd)

workflows:
  # set workflow version
  version: 2

  deployment-to-staging:
    jobs:
      - build
      - staging-deploy:
          requires:
            - build
          filters:
            branches:
              only: develop

  deployment-to-production:
      jobs:
        - build
        - production-deploy:
            requires:
              - build
            filters:
              branches:
                only: master
